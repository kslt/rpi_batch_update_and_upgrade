<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Raspberry Pi Manager</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    button { margin-bottom: 15px; margin-right: 10px; }

    /* Progress bar */
    .progress-container {
      width: 100%;
      background-color: #ddd;
      height: 20px;
      margin-bottom: 15px;
      border-radius: 10px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background-color: green;
      text-align: center;
      color: white;
      line-height: 20px;
      transition: width 0.3s;
    }

    /* Pi status */
    .pi-status { display: flex; align-items: center; margin-bottom: 5px; }
    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      background-color: black;
    }
    .status-text { font-weight: bold; }
    .status-black { color: black; }
    .status-green { color: green; }
    .status-red { color: red; }
    .status-yellow { color: goldenrod; }

    /* Stort statusfönster */
    #logOutput {
      margin-top: 15px;
      padding: 10px;
      background-color: #1e1e1e;
      color: #eee;
      font-family: monospace;
      height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>Raspberry Pi Manager</h1>

  <button id="updateBtn">Uppdatera alla Pis</button>
  <button id="rebootBtn">Reboota alla Pis</button>
  <button id="unattendedBtn">Aktivera Unattended Upgrades</button>
  <button id="cmdBtn">Kör eget kommando</button>

  <!-- Progress bar -->
  <div class="progress-container">
    <div class="progress-bar" id="progressBar">0%</div>
  </div>

  <!-- Lista med Pis -->
  <div id="statusContainer"></div>

  <!-- Stort loggfönster -->
  <div id="logOutput"></div>

  <script>
    const container = document.getElementById('statusContainer');
    const progressBar = document.getElementById('progressBar');
    const logOutput = document.getElementById('logOutput');

    let piElements = {};
    let totalPis = 0;
    let finishedPis = 0;

    // Gemensam funktion för att skicka kommando
    const sendCommand = (commandName, url) => {
      logOutput.textContent += `\nStartar: ${commandName}\n`;
      const evtSource = new EventSource(url);

      evtSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        const host = data.host || 'INFO';

        // Logga i stora fönstret
        logOutput.textContent += `[${host}] ${data.status}: ${data.message}\n`;
        logOutput.scrollTop = logOutput.scrollHeight;

        // Progresshantering för update-stream
        if (url.startsWith('/update-stream')) {
          if (!piElements[host] && host !== 'INFO') {
            const row = document.createElement('div');
            row.classList.add('pi-status');

            const dot = document.createElement('div');
            dot.classList.add('dot');

            const text = document.createElement('span');
            text.classList.add('status-text', 'status-black');
            text.textContent = host + ': ' + (data.message || '');

            row.appendChild(dot);
            row.appendChild(text);
            container.appendChild(row);

            piElements[host] = { dot, text };
            totalPis = Object.keys(piElements).length;
          } else if (piElements[host]) {
            piElements[host].text.textContent = host + ': ' + (data.message || '');
          }

          let dotColor = 'black';
          let textClass = 'status-black';

          if (data.status === 'done') {
            dotColor = 'green';
            textClass = 'status-green';
            finishedPis++;
          } else if (data.status === 'error') {
            dotColor = 'red';
            textClass = 'status-red';
            finishedPis++;
          } else if (/default/i.test(data.message)) {
            dotColor = 'yellow';
            textClass = 'status-yellow';
          }

          if (piElements[host]) {
            piElements[host].dot.style.backgroundColor = dotColor;
            piElements[host].text.className = 'status-text ' + textClass;
          }

          if (totalPis > 0) {
            let percent = Math.min(Math.round((finishedPis / totalPis) * 100), 100);
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
          }
        }
      };

      evtSource.onerror = () => {
        logOutput.textContent += `${commandName} avslutad eller anslutningsfel.\n`;
        evtSource.close();
      };
    };

    // Knappar
    document.getElementById('updateBtn').addEventListener('click', () => {
      container.innerHTML = '';
      logOutput.textContent = '';
      progressBar.style.width = '0%';
      progressBar.textContent = '0%';
      piElements = {};
      finishedPis = 0;

      sendCommand('Uppdatera alla Pis', '/update-stream');
    });

    document.getElementById('rebootBtn').addEventListener('click', () => {
      sendCommand('Rebootar alla Pis', '/command-stream?cmd=' + encodeURIComponent('sudo reboot'));
    });

    document.getElementById('unattendedBtn').addEventListener('click', () => {
      // Kör via din befintliga endpoint (kan också vara command-stream om du vill testa direktkommando)
      sendCommand('Aktiverar unattended-upgrades på alla Pis', '/enable-unattended');
    });

    document.getElementById('cmdBtn').addEventListener('click', () => {
      const cmd = prompt("Vilket kommando vill du köra?");
      if (cmd) {
        sendCommand(`Kör eget kommando: ${cmd}`, '/command-stream?cmd=' + encodeURIComponent(cmd));
      }
    });
  </script>
</body>
</html>
