<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Raspberry Pi Manager</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    button { margin: 5px; padding: 8px 15px; cursor: pointer; }

    /* Progress bar */
    .progress-container {
      width: 100%;
      background-color: #ddd;
      height: 20px;
      margin: 15px 0;
      border-radius: 10px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background-color: green;
      text-align: center;
      color: white;
      line-height: 20px;
      transition: width 0.3s;
    }

    /* Pi status */
    .pi-status { display: flex; align-items: center; margin-bottom: 5px; }
    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      background-color: black;
    }
    .status-text { font-weight: bold; }
    .status-black { color: black; }
    .status-green { color: green; }
    .status-red { color: red; }
    .status-yellow { color: goldenrod; }

    /* Stort statusfönster */
    #logOutput {
      margin-top: 15px;
      padding: 10px;
      background-color: #1e1e1e;
      color: #eee;
      font-family: monospace;
      height: 350px;
      overflow-y: auto;
      white-space: pre-wrap;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>Raspberry Pi Manager</h1>

  <!-- Knappfält -->
  <button id="updateBtn">Uppdatera alla Pis</button>
  <button id="rebootBtn">Reboota alla Pis</button>
  <button id="unattendedBtn">Aktivera Unattended Upgrades</button>
  <button id="cmdBtn">Kör eget kommando</button>

  <!-- Progress bar -->
  <div class="progress-container">
    <div class="progress-bar" id="progressBar">0%</div>
  </div>

  <!-- Lista med Pis -->
  <div id="statusContainer"></div>

  <!-- Stort loggfönster -->
  <div id="logOutput"></div>

  <script>
    const container = document.getElementById('statusContainer');
    const progressBar = document.getElementById('progressBar');
    const logOutput = document.getElementById('logOutput');

    let piElements = {};
    let totalPis = 0;
    let finishedPis = 0;

    // Gemensam loggfunktion
    function appendLog(msg) {
      logOutput.textContent += msg + "\n";
      logOutput.scrollTop = logOutput.scrollHeight;
    }

    // ---------------- UPDATE ----------------
    document.getElementById('updateBtn').addEventListener('click', () => {
      container.innerHTML = '';
      logOutput.textContent = '';
      progressBar.style.width = '0%';
      progressBar.textContent = '0%';
      piElements = {};
      finishedPis = 0;

      const evtSource = new EventSource('/update-stream');

      evtSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        let host = data.host || 'INFO';

        appendLog(`[${host}] ${data.status}: ${data.message}`);

        // Skapa element för host om det inte finns
        if (!piElements[host] && host !== 'INFO') {
          const row = document.createElement('div');
          row.classList.add('pi-status');

          const dot = document.createElement('div');
          dot.classList.add('dot');

          const text = document.createElement('span');
          text.classList.add('status-text', 'status-black');
          text.textContent = host + ': ' + (data.message || '');

          row.appendChild(dot);
          row.appendChild(text);
          container.appendChild(row);

          piElements[host] = { dot, text };
          totalPis = Object.keys(piElements).length;
        } else if (piElements[host]) {
          piElements[host].text.textContent = host + ': ' + (data.message || '');
        }

        // sätt färg på prick och text
        let dotColor = 'black';
        let textClass = 'status-black';

        if (data.status === 'done') {
          dotColor = 'green';
          textClass = 'status-green';
          finishedPis++;
        } else if (data.status === 'error') {
          dotColor = 'red';
          textClass = 'status-red';
          finishedPis++;
        } else if (/default/i.test(data.message)) {
          dotColor = 'yellow';
          textClass = 'status-yellow';
        }

        if (piElements[host]) {
          piElements[host].dot.style.backgroundColor = dotColor;
          piElements[host].text.className = 'status-text ' + textClass;
        }

        // Uppdatera progress bar
        if (totalPis > 0) {
          let percent = Math.min(Math.round((finishedPis / totalPis) * 100), 100);
          progressBar.style.width = percent + '%';
          progressBar.textContent = percent + '%';
        }
      };

      evtSource.onerror = () => {
        appendLog('Statusuppdatering avslutad eller anslutningsfel.');
        evtSource.close();
      };
    });

    // ---------------- GENERELL KOMMANDOFUNKTION ----------------
    function sendCommand(commandName, command) {
      appendLog(`\nStartar: ${commandName}`);
      const evtSource = new EventSource(`/command-stream?cmd=${encodeURIComponent(command)}`);

      evtSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        const host = data.host || 'INFO';
        appendLog(`[${host}] ${data.status}: ${data.message}`);
      };

      evtSource.onerror = () => {
        appendLog(`${commandName} avslutad eller anslutningsfel.`);
        evtSource.close();
      };
    }

    // ---------------- REBOOT ----------------
    document.getElementById('rebootBtn').addEventListener('click', () => {
      sendCommand('Rebootar alla Pis', 'sudo reboot');
    });

    // ---------------- UNATTENDED UPGRADES ----------------
    document.getElementById('unattendedBtn').addEventListener('click', () => {
      const unattendedCmd = 'sudo DEBIAN_FRONTEND=noninteractive apt-get install -y unattended-upgrades && sudo dpkg-reconfigure -f noninteractive unattended-upgrades';
      sendCommand('Aktiverar unattended-upgrades på alla Pis', unattendedCmd);
    });

    // ---------------- CUSTOM COMMAND ----------------
    document.getElementById('cmdBtn').addEventListener('click', () => {
      const cmd = prompt("Vilket kommando vill du köra?");
      if (cmd) {
        sendCommand(`Kör kommando: ${cmd}`, cmd);
      }
    });
  </script>
</body>
</html>
